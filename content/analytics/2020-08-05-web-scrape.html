---
title: Web Scraping
author: Jeff Cavanagh
date: '2020-08-05'
slug: web-scrape
categories:
  - R
tags:
  - rvest
  - Rselenium
lastmod: '2020-08-05T15:58:56-04:00'
layout: post
type: post
highlight: yes
---



<p><strong>Unfortunately, not all data is contained within neat dataframes. Much of the freely accessible data out there is posted on webpages. This post will serve as an introduction on how to extract that data using two packages: <code>rvest</code> and <code>rselenium</code>.</strong></p>
<div id="setup" class="section level3">
<h3>Setup</h3>
<div id="css-tool" class="section level4">
<h4>CSS Tool</h4>
<p>Webpages are not written in R code. They are written in HTML and CSS. A working knowledge of at least CSS is required to use the webscapring packages R provides.</p>
<p>Luckily for us there are free CSS selector tools to pull the the CSS links we need. I will be using the <a href="https://selectorgadget.com/" target="blank">SelectorGadget</a>.</p>
</div>
<div id="data" class="section level4">
<h4>Data</h4>
<p>The data will be practicing our techniques on is a page from IMDb that lists 50 comic book movies that were released between 2000 and 2019, ranked by popularity. Here was what the page data looks like:</p>
<p><img src="/analytics/2020-08-05-web-scrape_files/Screen%20Shot%202020-08-08%20at%202.43.03%20PM.png" /></p>
<p>The link can be found <a href="https://www.imdb.com/search/keyword/?keywords=based-on-comic-book%2Csuperhero&amp;pf_rd_m=A2FGELUUNOQJNL&amp;pf_rd_p=a581b14c-5a82-4e29-9cf8-54f909ced9e1&amp;pf_rd_r=HA259SA49EFNVTHNRH2V&amp;pf_rd_s=center-5&amp;pf_rd_t=15051&amp;pf_rd_i=genre&amp;ref_=kw_ref_yr&amp;sort=moviemeter,asc&amp;mode=detail&amp;page=1&amp;title_type=movie&amp;release_date=2000%2C2019" target="blank">here</a>.</p>
<p>Our primary goal will be to extract the different elements of data displayed on this page and translate it into a dataframe that is easy to use and manipulate. We will first do so with <code>rvest</code>.</p>
</div>
</div>
<div id="rvest" class="section level3">
<h3><code>rvest</code></h3>
<p>This package provides a host of functions that are designed to extract html code. The first thing we need to do to use it is use <code>read_html</code> to the read the full page.</p>
<pre class="r"><code>library(tidyverse)
library(rvest)
movies &lt;- read_html(&quot;https://www.imdb.com/search/keyword/?keywords=based-on-comic-book%2Csuperhero&amp;pf_rd_m=A2FGELUUNOQJNL&amp;pf_rd_p=a581b14c-5a82-4e29-9cf8-54f909ced9e1&amp;pf_rd_r=HA259SA49EFNVTHNRH2V&amp;pf_rd_s=center-5&amp;pf_rd_t=15051&amp;pf_rd_i=genre&amp;ref_=kw_ref_yr&amp;sort=moviemeter,asc&amp;mode=detail&amp;page=1&amp;title_type=movie&amp;release_date=2000%2C2019&quot;)</code></pre>
<p>Now that is done, we will start to extract different text elements of the page using <code>html_nodes</code> to identify all matches to the input CSS tag and <code>html_text</code> to extract the text. First let’s get all the movie titles.</p>
<p><img src="/analytics/2020-08-05-web-scrape_files/Screen%20Shot%202020-08-08%20at%2012.37.06%20PM.png" /></p>
<pre class="r"><code>titles &lt;- movies %&gt;%
  html_nodes(&quot;.lister-item-header a&quot;) %&gt;%
  html_text()</code></pre>
<p>Using the same approach we can collect the other statistics from each movie. Let’s do that now for each movies popularity ranking, rating, IMDb rating, runtime, genre, plot, domestic gross, directors, and actors.</p>
<pre class="r"><code>ranking&lt;- movies %&gt;%
  html_nodes(&quot;.text-primary&quot;) %&gt;%
  html_text() %&gt;%
  as.numeric()
head(ranking)</code></pre>
<pre><code>## [1] 1 2 3 4 5 6</code></pre>
<pre class="r"><code>rating &lt;- movies %&gt;%
  html_nodes(&quot;.certificate&quot;) %&gt;%
  html_text()
head(rating)</code></pre>
<pre><code>## [1] &quot;PG-13&quot; &quot;PG-13&quot; &quot;PG-13&quot; &quot;PG-13&quot; &quot;PG-13&quot; &quot;PG-13&quot;</code></pre>
<pre class="r"><code>IMDb_rating &lt;- movies %&gt;%
  html_nodes(&quot;.ratings-imdb-rating strong&quot;) %&gt;%
  html_text() %&gt;%
  as.numeric()
head(IMDb_rating)</code></pre>
<pre><code>## [1] 8.4 9.0 8.0 7.4 6.0 8.4</code></pre>
<pre class="r"><code>runtime &lt;- movies %&gt;%
  html_nodes(&quot;.runtime&quot;) %&gt;%
  html_text() %&gt;% # translating from a character string to numeric vector
  str_sub(1,-5) %&gt;%
  as.integer()
head(runtime)</code></pre>
<pre><code>## [1] 181 152 121 141 123 164</code></pre>
<pre class="r"><code>genre &lt;- movies %&gt;%
  html_nodes(&quot;.genre&quot;) %&gt;%
  html_text() %&gt;% # cleaning character string
  str_remove(&quot;^\\n&quot;) %&gt;%
  str_squish()
head(genre)</code></pre>
<pre><code>## [1] &quot;Action, Adventure, Drama&quot;   &quot;Action, Crime, Drama&quot;      
## [3] &quot;Action, Adventure, Comedy&quot;  &quot;Action, Adventure, Fantasy&quot;
## [5] &quot;Action, Adventure, Fantasy&quot; &quot;Action, Adventure&quot;</code></pre>
<pre class="r"><code>plot &lt;- movies %&gt;%
  html_nodes(&quot;.ratings-bar+ p&quot;) %&gt;%
  html_text() %&gt;% # cleaning up character strings
  str_remove(&quot;^\\n\\s+&quot;)
head(plot)</code></pre>
<pre><code>## [1] &quot;After the devastating events of Avengers: Infinity War (2018), the universe is in ruins. With the help of remaining allies, the Avengers assemble once more in order to reverse Thanos&#39; actions and restore balance to the universe.&quot;
## [2] &quot;When the menace known as the Joker wreaks havoc and chaos on the people of Gotham, Batman must accept one of the greatest psychological and physical tests of his ability to fight injustice.&quot;                                       
## [3] &quot;A group of intergalactic criminals must pull together to stop a fanatical warrior with plans to purge the universe.&quot;                                                                                                                 
## [4] &quot;When a pilot crashes and tells of conflict in the outside world, Diana, an Amazonian warrior in training, leaves home to fight a war, discovering her full powers and true destiny.&quot;                                                 
## [5] &quot;A secret government agency recruits some of the most dangerous incarcerated super-villains to form a defensive task force. Their first mission: save the world from the apocalypse.&quot;                                                 
## [6] &quot;Eight years after the Joker&#39;s reign of anarchy, Batman, with the help of the enigmatic Catwoman, is forced from his exile to save Gotham City from the brutal guerrilla terrorist Bane.&quot;</code></pre>
<pre class="r"><code>gross_domestic &lt;- movies %&gt;%
  html_nodes(&quot;.ghost~ .text-muted+ span&quot;) %&gt;%
  html_text() %&gt;% # translating from a character string into a numeric vector
  str_remove_all(&quot;^\\$|M$&quot;) %&gt;% # all of our entries are in millions so easy to convert
  as.numeric() * 1e6
head(gross_domestic)</code></pre>
<pre><code>## [1] 858370000 534860000 333180000 412560000 325100000 448140000</code></pre>
<pre class="r"><code>directors1 &lt;- movies %&gt;%
  html_nodes(&quot;.text-small a:nth-child(1)&quot;) %&gt;%
  html_text()
head(directors1)</code></pre>
<pre><code>## [1] &quot;Anthony Russo&quot;     &quot;Christopher Nolan&quot; &quot;James Gunn&quot;       
## [4] &quot;Patty Jenkins&quot;     &quot;David Ayer&quot;        &quot;Christopher Nolan&quot;</code></pre>
<pre class="r"><code>length(directors1)</code></pre>
<pre><code>## [1] 50</code></pre>
<pre class="r"><code>directors2 &lt;- movies %&gt;%
  html_nodes(&quot;.text-small a:nth-child(1) , .text-small a:nth-child(2)&quot;) %&gt;%
  html_text()
head(directors2)</code></pre>
<pre><code>## [1] &quot;Anthony Russo&quot;     &quot;Joe Russo&quot;         &quot;Christopher Nolan&quot;
## [4] &quot;James Gunn&quot;        &quot;Patty Jenkins&quot;     &quot;David Ayer&quot;</code></pre>
<pre class="r"><code>length(directors2)</code></pre>
<pre><code>## [1] 55</code></pre>
<pre class="r"><code>actors1 &lt;- movies %&gt;%
  html_nodes(&quot;.text-small .ghost+ a&quot;) %&gt;%
  html_text()
head(actors1)</code></pre>
<pre><code>## [1] &quot;Robert Downey Jr.&quot; &quot;Christian Bale&quot;    &quot;Chris Pratt&quot;      
## [4] &quot;Gal Gadot&quot;         &quot;Will Smith&quot;        &quot;Christian Bale&quot;</code></pre>
<pre class="r"><code>length(actors1)</code></pre>
<pre><code>## [1] 50</code></pre>
<pre class="r"><code>actors2 &lt;- movies %&gt;%
  html_nodes(&quot;.text-small .ghost~ a&quot;) %&gt;%
  html_text()
head(actors2)</code></pre>
<pre><code>## [1] &quot;Robert Downey Jr.&quot; &quot;Chris Evans&quot;       &quot;Mark Ruffalo&quot;     
## [4] &quot;Chris Hemsworth&quot;   &quot;Christian Bale&quot;    &quot;Heath Ledger&quot;</code></pre>
<pre class="r"><code>length(actors2)</code></pre>
<pre><code>## [1] 200</code></pre>
<p>For the most part we cleaned each vector we compiled as we extracted the data. Take note of the actor and director variables though. <code>director1</code> and <code>actor1</code> each have a length of 50 (matching the rest of the data). <code>director2</code> and <code>actor2</code> have more entries though, because all the movies on the list have more than one actor, and some have multiple directors.</p>
<p>To rectify this we will combine concatentate these strings with <code>str_c</code> using <code>for</code> loops. To do this, we will index the directors by appearance in the <code>directors1</code> and by taking groupings of four actors (as four actors are listed for each movie).</p>
<pre class="r"><code>ind &lt;- which(directors2 %in% directors1) %&gt;% append(length(directors2)+1)
directors &lt;- c()
for (i in 1:(length(ind)-1)){
  directors[i] &lt;- str_c(directors2[c(ind[i]:(ind[i+1]-1))], collapse = &quot;, &quot;)
}
head(directors)</code></pre>
<pre><code>## [1] &quot;Anthony Russo, Joe Russo&quot; &quot;Christopher Nolan&quot;       
## [3] &quot;James Gunn&quot;               &quot;Patty Jenkins&quot;           
## [5] &quot;David Ayer&quot;               &quot;Christopher Nolan&quot;</code></pre>
<pre class="r"><code>actors &lt;- c()
for(i in 1:length(actors1)){
  actors[i] &lt;- str_c(actors2[c(((i-1) * 4 + 1):(4 * i))], collapse = &quot;, &quot;)
}
head(actors)</code></pre>
<pre><code>## [1] &quot;Robert Downey Jr., Chris Evans, Mark Ruffalo, Chris Hemsworth&quot;
## [2] &quot;Christian Bale, Heath Ledger, Aaron Eckhart, Michael Caine&quot;   
## [3] &quot;Chris Pratt, Vin Diesel, Bradley Cooper, Zoe Saldana&quot;         
## [4] &quot;Gal Gadot, Chris Pine, Robin Wright, Lucy Davis&quot;              
## [5] &quot;Will Smith, Jared Leto, Margot Robbie, Viola Davis&quot;           
## [6] &quot;Christian Bale, Tom Hardy, Anne Hathaway, Gary Oldman&quot;</code></pre>
<p>We now have most of the primary data we were searching for. Now lets combine it into a functioning data frame.</p>
<pre class="r"><code>superhero_movies &lt;- tibble(
  titles,
  popularity_rank = ranking,
  IMDb_rating,
  rating,
  runtime,
  genre,
  gross_domestic,
  plot,
  directors,
  actors
)
str(superhero_movies)</code></pre>
<pre><code>## tibble [50 × 10] (S3: tbl_df/tbl/data.frame)
##  $ titles         : chr [1:50] &quot;Avengers: Endgame&quot; &quot;The Dark Knight&quot; &quot;Guardians of the Galaxy&quot; &quot;Wonder Woman&quot; ...
##  $ popularity_rank: num [1:50] 1 2 3 4 5 6 7 8 9 10 ...
##  $ IMDb_rating    : num [1:50] 8.4 9 8 7.4 6 8.4 7.6 7 6.3 8.4 ...
##  $ rating         : chr [1:50] &quot;PG-13&quot; &quot;PG-13&quot; &quot;PG-13&quot; &quot;PG-13&quot; ...
##  $ runtime        : int [1:50] 181 152 121 141 123 164 136 143 120 149 ...
##  $ genre          : chr [1:50] &quot;Action, Adventure, Drama&quot; &quot;Action, Crime, Drama&quot; &quot;Action, Adventure, Comedy&quot; &quot;Action, Adventure, Fantasy&quot; ...
##  $ gross_domestic : num [1:50] 8.58e+08 5.35e+08 3.33e+08 4.13e+08 3.25e+08 ...
##  $ plot           : chr [1:50] &quot;After the devastating events of Avengers: Infinity War (2018), the universe is in ruins. With the help of remai&quot;| __truncated__ &quot;When the menace known as the Joker wreaks havoc and chaos on the people of Gotham, Batman must accept one of th&quot;| __truncated__ &quot;A group of intergalactic criminals must pull together to stop a fanatical warrior with plans to purge the universe.&quot; &quot;When a pilot crashes and tells of conflict in the outside world, Diana, an Amazonian warrior in training, leave&quot;| __truncated__ ...
##  $ directors      : chr [1:50] &quot;Anthony Russo, Joe Russo&quot; &quot;Christopher Nolan&quot; &quot;James Gunn&quot; &quot;Patty Jenkins&quot; ...
##  $ actors         : chr [1:50] &quot;Robert Downey Jr., Chris Evans, Mark Ruffalo, Chris Hemsworth&quot; &quot;Christian Bale, Heath Ledger, Aaron Eckhart, Michael Caine&quot; &quot;Chris Pratt, Vin Diesel, Bradley Cooper, Zoe Saldana&quot; &quot;Gal Gadot, Chris Pine, Robin Wright, Lucy Davis&quot; ...</code></pre>
<p>There is one more feauture of <code>rvest</code> I would like to illustrate before we close out this tutorial, and that is how to extract links.</p>
<p>We will add one more column to our new data frame that gives the link to each movie’s page using <code>html_attr</code>. All we need to do is add one more input, “href”, which tells the function we want the link, not the text of the CSS tag element.</p>
<pre class="r"><code>pages &lt;- movies %&gt;%
  html_nodes(&quot;.lister-item-header a&quot;) %&gt;%
  html_attr(&quot;href&quot;)
head(pages)</code></pre>
<pre><code>## [1] &quot;/title/tt4154796/?ref_=kw_li_tt&quot; &quot;/title/tt0468569/?ref_=kw_li_tt&quot;
## [3] &quot;/title/tt2015381/?ref_=kw_li_tt&quot; &quot;/title/tt0451279/?ref_=kw_li_tt&quot;
## [5] &quot;/title/tt1386697/?ref_=kw_li_tt&quot; &quot;/title/tt1345836/?ref_=kw_li_tt&quot;</code></pre>
<p>This now gives us the addres’s within the main website, to get the full urls all we have to do is add the main site address to the start of each string.</p>
<pre class="r"><code>pages &lt;- str_c(&quot;https://www.imdb.com&quot;, pages)
superhero_movies &lt;- cbind(superhero_movies, pages)
superhero_movies %&gt;% head()</code></pre>
<pre><code>##                    titles popularity_rank IMDb_rating rating runtime
## 1       Avengers: Endgame               1         8.4  PG-13     181
## 2         The Dark Knight               2         9.0  PG-13     152
## 3 Guardians of the Galaxy               3         8.0  PG-13     121
## 4            Wonder Woman               4         7.4  PG-13     141
## 5           Suicide Squad               5         6.0  PG-13     123
## 6   The Dark Knight Rises               6         8.4  PG-13     164
##                        genre gross_domestic
## 1   Action, Adventure, Drama      858370000
## 2       Action, Crime, Drama      534860000
## 3  Action, Adventure, Comedy      333180000
## 4 Action, Adventure, Fantasy      412560000
## 5 Action, Adventure, Fantasy      325100000
## 6          Action, Adventure      448140000
##                                                                                                                                                                                                                                   plot
## 1 After the devastating events of Avengers: Infinity War (2018), the universe is in ruins. With the help of remaining allies, the Avengers assemble once more in order to reverse Thanos&#39; actions and restore balance to the universe.
## 2                                        When the menace known as the Joker wreaks havoc and chaos on the people of Gotham, Batman must accept one of the greatest psychological and physical tests of his ability to fight injustice.
## 3                                                                                                                  A group of intergalactic criminals must pull together to stop a fanatical warrior with plans to purge the universe.
## 4                                                  When a pilot crashes and tells of conflict in the outside world, Diana, an Amazonian warrior in training, leaves home to fight a war, discovering her full powers and true destiny.
## 5                                                  A secret government agency recruits some of the most dangerous incarcerated super-villains to form a defensive task force. Their first mission: save the world from the apocalypse.
## 6                                              Eight years after the Joker&#39;s reign of anarchy, Batman, with the help of the enigmatic Catwoman, is forced from his exile to save Gotham City from the brutal guerrilla terrorist Bane.
##                  directors
## 1 Anthony Russo, Joe Russo
## 2        Christopher Nolan
## 3               James Gunn
## 4            Patty Jenkins
## 5               David Ayer
## 6        Christopher Nolan
##                                                          actors
## 1 Robert Downey Jr., Chris Evans, Mark Ruffalo, Chris Hemsworth
## 2    Christian Bale, Heath Ledger, Aaron Eckhart, Michael Caine
## 3          Chris Pratt, Vin Diesel, Bradley Cooper, Zoe Saldana
## 4               Gal Gadot, Chris Pine, Robin Wright, Lucy Davis
## 5            Will Smith, Jared Leto, Margot Robbie, Viola Davis
## 6         Christian Bale, Tom Hardy, Anne Hathaway, Gary Oldman
##                                                 pages
## 1 https://www.imdb.com/title/tt4154796/?ref_=kw_li_tt
## 2 https://www.imdb.com/title/tt0468569/?ref_=kw_li_tt
## 3 https://www.imdb.com/title/tt2015381/?ref_=kw_li_tt
## 4 https://www.imdb.com/title/tt0451279/?ref_=kw_li_tt
## 5 https://www.imdb.com/title/tt1386697/?ref_=kw_li_tt
## 6 https://www.imdb.com/title/tt1345836/?ref_=kw_li_tt</code></pre>
<p>And viola! We have taken the contents of a webpage and turned it into a useful dataframe tracking superhero movies and all of their attached statistics.</p>
</div>
<div id="rselenium" class="section level3">
<h3><code>rselenium</code></h3>
</div>
